/* 
 This source code (the "Generated Software") is generated by the OutSystems Platform 
 and is licensed by OutSystems (http://www.outsystems.com) to You solely for testing and evaluation 
 purposes, unless You and OutSystems have executed a specific agreement covering the use terms and 
 conditions of the Generated Software, in which case such agreement shall apply. 
*/

using System;
using System.Collections;
using System.Web.UI;
using OutSystems.HubEdition.RuntimePlatform.Web;
using OutSystems.RuntimeCommon;

namespace OutSystems.HubEdition.WebWidgets {

    //this is a dummy link to force tha page to have a __DoPostBack
    //#270823
    public class DummySubmitLink : System.Web.UI.WebControls.LinkButton {

        public DummySubmitLink()
            : base() {

        }

        protected override StateBag ViewState {
            get {
                return new StateBag();
            }
        }

        protected override void Render(HtmlTextWriter writer) {
            //Do nothing
        }

        public override void RenderBeginTag(HtmlTextWriter writer) {
            //Do nothing
        }

        protected override void RenderContents(HtmlTextWriter writer) {
            //Do nothing
        }

        public override void RenderEndTag(HtmlTextWriter writer) {
            //Do nothing
        }

        //Properties
        public override bool CausesValidation {
            get {
                return false;
            }
            set {

            }
        }

        public override bool Enabled {
            get {
                return true;
            }
            set {
                base.Enabled = value;
            }
        }

        public override string PostBackUrl {
            get {
                return String.Empty;
            }
            set {
                base.PostBackUrl = value;
            }
        }

    }
    
    public sealed class LinkButton : System.Web.UI.WebControls.LinkButton, IParentEditRecordProp, IViewStateAttributes, IAjaxHandler, IAjaxClickEvent, IBreakPointControl, IOSControl {

        public LinkButton()
            : base() {
            _viewStateAttributes = new ViewStateAttributes(this, Attributes, ViewState);
        }

        private ViewStateAttributes _viewStateAttributes;
        public ViewStateAttributes ViewStateAttributes {
            get {
                return _viewStateAttributes;
            }
        }

        private string _confirmMessage;
        public string ConfirmationMessage {
            get {
                return _confirmMessage;
            }
            set {
                _confirmMessage = value;
            }
        }

        private Hashtable events;
        public void RegisterAjaxEvent(AjaxEventType eventType, Array controlIdsToSend) {
            if (events == null) {
                events = new Hashtable();
            }

            events[eventType] = controlIdsToSend;
        }

        public Hashtable GetRegisteredAjaxEvents() {
            return events;
        }

        public string ParentEditRecord { get; set; }
        public ParentEditRecordPropType ValidatorType { get { return ParentEditRecordPropType.PERFORMS_VALIDATION; } }

        /// <summary>
        /// This is exactly the same as in System.Web.UI.WebControls.LinkButton, only the javascript
        /// of the href attribute is diferent.
        /// This change was done to support FireFox (#37171)
        /// </summary>
        /// <param name="writer"></param>
        protected override void AddAttributesToRender(HtmlTextWriter writer) {
            using (var w = new HtmlTextWriterWithAttributeFilter(writer)) {
                if (Page != null) {
                    Page.VerifyRenderingInServerForm(this);
                }

                if (ID != null) {
                    w.AddAttribute(HtmlTextWriterAttribute.Id, ClientID);
                }

                if (AccessKey.Length > 0) {
                    w.AddAttribute(HtmlTextWriterAttribute.Accesskey, AccessKey);
                }

                if (!Enabled) {
                    w.AddAttribute(HtmlTextWriterAttribute.Disabled, ((OSPage)Page).QuirksMode ? null : "disabled");
                }

                if (TabIndex != 0) {
                    w.AddAttribute(HtmlTextWriterAttribute.Tabindex, TabIndex.ToString());
                }

                if (ToolTip.Length > 0) {
                    w.AddAttribute(HtmlTextWriterAttribute.Title, ToolTip);
                }

                if (ControlStyleCreated) {
                    ControlStyle.AddAttributesToRender(w, this);
                }

                bool isAjax = (events != null) && events.Contains(AjaxEventType.onAjaxClick);

                string onClickText = JavaScriptManager.GetButtonOnClickCode(ClientID, UniqueID, ViewStateAttributes.InlineAttributes["onclick"],
                    _confirmMessage, isAjax, CausesValidation);

                if (onClickText.Length > 0) {
                    ViewStateAttributes.InlineAttributes["onclick"] = onClickText;
                }

                // remove the onclick javascript handler if the control is disabled
                if (!Enabled) {
                    ViewStateAttributes.InlineAttributes.Remove("onclick");
                }

                foreach (string attr in Attributes.Keys) {
                    w.AddAttribute(attr, Attributes[attr]);
                }

                ViewStateAttributes.InlineAttributes.AddAttributes(w);

                // "#"
                if (Enabled && (Page != null)) {
                    string htmlTextAttribute = JavaScriptManager.GetLinkHRefCode(ClientID, isAjax, CausesValidation,
                        Page.ClientScript.GetPostBackEventReference(this, ""), Page.ClientScript.GetPostBackClientHyperlink(this, ""));

                    w.AddAttribute(HtmlTextWriterAttribute.Href, htmlTextAttribute);
                }
            }
        }

        #region IBreakPointControl implementation

        private String _BreakpointHookId;
        private bool _BreakpointHookIsExpressionlessWidget = false;

        public event BreakpointHook BreakpointHookEvent;

        public string BreakpointHookId {
            get { return _BreakpointHookId; }
            set { _BreakpointHookId = value; }
        }

        public bool BreakpointHookIsExpressionlessWidget {
            get { return _BreakpointHookIsExpressionlessWidget; }
            set { _BreakpointHookIsExpressionlessWidget = value; }
        }

        public override void DataBind() {
            if (BreakpointHookEvent != null) {
                BreakpointHookEvent(BreakpointHookId, BreakpointHookIsExpressionlessWidget);
            }
            base.DataBind();
        }

        #endregion

        protected override void RaisePostBackEvent(string eventArgument) {
            // cancel raise postback event for all ajax events, so the submit/click event is not triggered in those cases
            if (Page.Request.Form["__AJAXEVENT"] == null)
                base.RaisePostBackEvent(eventArgument);
        }


        #region IAjaxClickEvent Members

        public event EventHandler AjaxClick;

        public void OnAjaxClick(EventArgs e) {
            AjaxEventsHelper.RaiseAjaxEvent(this, AjaxClick);
        }

        #endregion

        #region IOSControl members
        string IOSControl.TagName { get { return this.TagName; } }
        string[] IOSControl.CssClass { get { return this.CssClass.Split(' '); } }
        #endregion
    }
}
