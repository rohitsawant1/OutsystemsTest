/* 
 This source code (the "Generated Software") is generated by the OutSystems Platform 
 and is licensed by OutSystems (http://www.outsystems.com) to You solely for testing and evaluation 
 purposes, unless You and OutSystems have executed a specific agreement covering the use terms and 
 conditions of the Generated Software, in which case such agreement shall apply. 
*/

using System;
using System.Collections;
using System.Collections.Specialized;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Xml;
using OutSystems.HubEdition.RuntimePlatform;
using OutSystems.HubEdition.RuntimePlatform.Web;
using OutSystems.RuntimeCommon;
using OutSystems.WidgetsRuntimeAPI;

namespace OutSystems.HubEdition.WebWidgets {
    public sealed class CheckBox : WebControl, IPostBackDataHandler, IViewStateAttributes, IBreakPointControl, IAjaxHandler, IAjaxChangeEvent, IWidgetWithParentEditRecordAndValidation, IGridWidget, IOSControl {

        private bool _valid = true;
        private string _typedValue = "";
        private string _validationMessage = "";

        static CheckBox() {
            CheckBox.EventCheckedChanged = new object();
        }

        public CheckBox()
            : base(HtmlTextWriterTag.Input) {
            _viewStateAttributes = new ViewStateAttributes(this, Attributes, ViewState);
        }

        #region IWidgetRuntimeProperties implementation

        public bool Valid {
            get {
                return _valid;
            }
            set {
                _valid = value;
            }
        }

        bool IControlWithValidation.Validate(ScreenContext context) {
            return Valid;
        }

        public bool Mandatory {
            get {
                return true;
            }
            set { }
        }

        public string TypedValue {
            get {
                return _typedValue;
            }
            set {
                _typedValue = value;
            }
        }

        public string ValidationMessage {
            get {
                return _validationMessage;
            }
            set {
                _validationMessage = value;
            }
        }

        public string TypeValidationMessage {
            get {
                return "";
            }
            set { }
        }
        public string MandatoryValidationMessage {
            get {
                return "";
            }
            set { }
        }

        #endregion

        private void OnCheckedChanged(EventArgs e) {
            EventHandler handler = ((EventHandler)base.Events[CheckBox.EventCheckedChanged]);
            if (handler != null) {
                handler.Invoke(this, e);
            }
        }

        bool IPostBackDataHandler.LoadPostData(string postDataKey, NameValueCollection postCollection) {
            string value = postCollection[postDataKey];

            if (value != null) {
                Checked = (value == "on");
                return true;
            }
            // Don't think this should ever happen now as we always inject an input for checkboxes...
            return false;
        }

        void IPostBackDataHandler.RaisePostDataChangedEvent() {
            OnCheckedChanged(EventArgs.Empty);
        }

        public event EventHandler CheckedChanged {
            add {
                base.Events.AddHandler(CheckBox.EventCheckedChanged, value);
            }
            remove {
                base.Events.RemoveHandler(CheckBox.EventCheckedChanged, value);
            }
        }

        private bool _checked = false;
        public bool Checked {
            get {
                return _checked;
            }
            set {
                _checked = value;
            }
        }

        private static readonly object EventCheckedChanged;

        protected override void AddAttributesToRender(HtmlTextWriter writer) {
            using (var w = new HtmlTextWriterWithAttributeFilter(writer)) {
                Page.VerifyRenderingInServerForm(this);

                w.AddAttribute(HtmlTextWriterAttribute.Type, "checkbox");
                w.AddAttribute(HtmlTextWriterAttribute.Name, UniqueID);
                if (Checked) {
                    w.AddAttribute(HtmlTextWriterAttribute.Checked, ((OSPage)Page).QuirksMode ? null : "checked");
                }

                bool old_Enabled = Enabled;
                if (!Enabled) {
                    w.AddAttribute(HtmlTextWriterAttribute.Disabled, ((OSPage)Page).QuirksMode ? null : "disabled");
                    Enabled = true;
                }

                // add to class='' the Valid style
                if (!this._valid) {
                    string cssClass = this.CssClass;
                    if (cssClass != null && cssClass != "") {
                        this.CssClass = this.CssClass + " Not_Valid";
                    } else {
                        this.CssClass = "Not_Valid";
                    }
                }
                this.Attributes.Add("aria-invalid", (!this._valid).ToString().ToLower());

                // dump ajax onchange handler
                AjaxEventsHelper.AddAjaxEventAttribute(this, AjaxEventType.onAjaxChange, ClientID, UniqueID, "__OSVSTATE", ViewStateAttributes.InlineAttributes);
                base.AddAttributesToRender(w);
                ViewStateAttributes.InlineAttributes.AddAttributes(w);
                Enabled = old_Enabled;
            }
        }

        #region IBreakPointControl implementation

        private String _BreakpointHookId;
        private bool _BreakpointHookIsExpressionlessWidget = false;

        public event BreakpointHook BreakpointHookEvent;

        public string BreakpointHookId {
            get { return _BreakpointHookId; }
            set { _BreakpointHookId = value; }
        }

        public bool BreakpointHookIsExpressionlessWidget {
            get { return _BreakpointHookIsExpressionlessWidget; }
            set { _BreakpointHookIsExpressionlessWidget = value; }
        }

        protected override void OnInit(EventArgs e) {
            base.OnInit(e);
            this.AddGridClassesAttribute();
        }

        public override void DataBind() {
            if (BreakpointHookEvent != null) {
                BreakpointHookEvent(BreakpointHookId, BreakpointHookIsExpressionlessWidget);
            }
            base.DataBind();
        }

        #endregion

        protected override void Render(HtmlTextWriter writer) {
            RenderBeginTag(writer);
            RenderContents(writer);
            RenderEndTag(writer);

            writer.WriteBeginTag("span");
            writer.WriteAttribute("style", "display: none;");
            writer.WriteAttribute("class", "ValidationMessage");
            writer.WriteAttribute("role", "alert");
            writer.WriteAttribute("id", "ValidationMessage_" + ClientID);
            writer.Write(">");
            writer.WriteEndTag("span");
            if (!_valid)
                writer.Write(JavaScriptManager.GetInvalidInputJS(ClientID, _validationMessage));

        }

        private Hashtable events;
        public void RegisterAjaxEvent(AjaxEventType eventType, Array controlIdsToSend) {
            if (events == null) {
                events = new Hashtable();
            }

            events[eventType] = controlIdsToSend;
        }

        public Hashtable GetRegisteredAjaxEvents() {
            return events;
        }

        #region Grid Child Widget implementation

        public string GridCssClasses { get; set; }

        #endregion Grid Child Widget implementation

        #region IAjaxChangeEvent implementation

        public event EventHandler AjaxChange;

        public void OnAjaxChange(EventArgs e) {
            AjaxEventsHelper.RaiseAjaxEvent(this, AjaxChange);
        }

        #endregion

        #region IViewStateAttributes Members

        ViewStateAttributes _viewStateAttributes;
        public ViewStateAttributes ViewStateAttributes {
            get {
                return _viewStateAttributes;
            }
        }

        #endregion

        #region IOSControl members
        string IOSControl.TagName { get { return this.TagName; } }
        string[] IOSControl.CssClass { get { return this.CssClass.Split(' '); } }
        #endregion

        public void ToXml(Object parent, XmlElement baseElem, String fieldName, int detailLevel) {
            // baseElem is already the widget element, so all we need to do is to add the
            // CheckBox own properties
            if (detailLevel > 0) {
                VarValue.AppendAttribute(baseElem, "Valid", Valid, TypeKind.Boolean);
                VarValue.AppendAttribute(baseElem, "ValidationMessage", ValidationMessage, TypeKind.Text);
            }
        }

        public void EvaluateFields(VarValue variable, Object parent, String baseName, String fields) {
            // baseElem is already the widget element, so all we need to do is to check the
            // ComboBox own properties
            String head = VarValue.GetHead(fields);
            String tail = VarValue.GetTail(fields);
            if (head == "valid")
                variable.Value = Valid;
            else if (head == "validationmessage")
                variable.Value = ValidationMessage;
        }

        public string ParentEditRecord { get; set; }
        public ParentEditRecordPropType ValidatorType { get { return ParentEditRecordPropType.NEEDS_VALIDATION; } }
    }
}