/* 
 This source code (the "Generated Software") is generated by the OutSystems Platform 
 and is licensed by OutSystems (http://www.outsystems.com) to You solely for testing and evaluation 
 purposes, unless You and OutSystems have executed a specific agreement covering the use terms and 
 conditions of the Generated Software, in which case such agreement shall apply. 
*/

using System;
using System.Collections.Generic;
using System.IO;
using System.Web;
using System.Web.UI;
using OutSystems.Common;
using OutSystems.HubEdition.RuntimePlatform;
using OutSystems.HubEdition.RuntimePlatform.Log;
using OutSystems.HubEdition.RuntimePlatform.Web;
using OutSystems.ObjectKeys;
using OutSystems.RuntimeCommon;

namespace OutSystems.HubEdition.WebWidgets {
    public abstract class OSPage : BasePage, IObjectWithViewState {
        public BlocksJavascript BlocksJavaScript { get; private set; }

        public readonly bool QuirksMode;

        protected OSPage(bool quirksMode) {
            BlocksJavaScript = new BlocksJavascript(this);
            QuirksMode = quirksMode;
            RegisterPageClientScripts();
        }

        protected void RegisterPageClientScripts() {
            // Client-side scripting enabling
            // These scripts are always added, regardless of the existance of buttons/links with client side validation,
            // because using Ajax we can later on add them
            Page.ClientScript.RegisterOnSubmitStatement(Page.GetType(), "OsFixCheckboxesOnSubmit", JavaScriptManager.onSubmitFixCheckboxesCode);
            Page.ClientScript.RegisterOnSubmitStatement(Page.GetType(), "OsFixUploadOnSubmit", JavaScriptManager.onSubmitFixUploadCode);
            Page.ClientScript.RegisterStartupScript(Page.GetType(), "OsValidatorIncludeScript", JavaScriptManager.startupScript);
            Page.ClientScript.RegisterOnSubmitStatement(Page.GetType(), "OsValidatorOnSubmit", JavaScriptManager.onSubmitValidationCode);
        }

        protected bool ViewStateIsValid = false;

        /// <summary>
        /// Restore widget and variable data from the viewstate
        /// </summary>
        protected virtual void FetchViewState() {
            if (!ViewStateIsValid && RuntimePlatformSettings.ViewState.EncryptViewState.GetValue()) {
                throw new Exception("Invalid viewstate in postback");
            }
        }

        private bool _pageNeedsToValidateCachedObjects = false;

        public bool PageNeedsToValidateCachedObjects {
            get {
                return _pageNeedsToValidateCachedObjects;
            }
            set {
                _pageNeedsToValidateCachedObjects = value;
            }
        }

        protected override void LoadViewState(object savedState) {
            base.LoadViewState(savedState);
            BlocksJavaScript.LoadAlreadyIncludedBlocks(ViewState);
        }

        protected void DisableViewState(Control c) {
            if (c == null) {
                return;
            }
            if (c is System.Web.UI.HtmlControls.HtmlInputFile) {
                c.EnableViewState = false;
            }

            string typeName = c.GetType().ToString();
            if (typeName == "System.Web.UI.DataBoundLiteralControl" ||
                typeName == "OutSystems.HubEdition.WebWidgets.DropDownList" ||
                typeName == "System.Web.UI.WebControls.DataGridTable" ||
                typeName == "OutSystems.HubEdition.WebWidgets.TextBox" ||
                typeName == "OutSystems.HubEdition.WebWidgets.CheckBox" ||
                typeName == "OutSystems.HubEdition.WebWidgets.Button" ||
                typeName == "OutSystems.HubEdition.WebWidgets.DynamicImage" ||
                typeName == "OutSystems.HubEdition.WebWidgets.HyperLink" ||
                typeName == "System.Web.UI.WebControls.Panel" ||
                typeName == "OutSystems.HubEdition.WebWidgets.LinkButton") {

                c.EnableViewState = false;
            }
            foreach (Control child in c.Controls) {
                DisableViewState(child);
            }
        }

        public override ValidateRequestMode ValidateRequestMode {
            get {
                return ValidateRequestMode.Disabled;
            }
            set {
                // prevents the set's so it doesn't end up in viewstate
            }
        }

        protected virtual void WriteBlockJavaScriptIncludes(StringWriter writer) {
            BlocksJavaScript.WriteBlockJavaScriptIncludes(writer);
        }

        public void RegisterBlock(OSUserControl block, out BlocksJavascript.JavascriptNode javascriptNode) {
            javascriptNode = BlocksJavaScript.RegisterBlock(block);
        }

        // TODO: remove in P10+, API changed in a revision, kept to avoid breaking Application when the entire factory is not published
        public void RegisterBlock(OSUserControl block) {
            BlocksJavaScript.RegisterBlock(block);
        }
        /// <summary>
        /// Checks if a given control set as event target of a request will trigger any bubble up event in a parent OsDataGrid or Iterator
        /// </summary>
        /// <param name="eventTarget"></param>
        /// <returns></returns>
        public bool TriggersBubbleUpEvents(Control eventTarget) {
            // Cancel bubble up events for datagrind or iterator
            if (eventTarget is OSDataGrid) {
                return true;
            } else if (eventTarget is Iterator) {
                return true;
            }
            // follow to parent
            if (eventTarget.Parent != null) {
                return TriggersBubbleUpEvents(eventTarget.Parent);
            } else {
                return false;
            }

        }

        private const string REPORT_TO_HEADER_GROUP_NAME = "outsystems-csp-report";

        public override void DataBind() {
            if (!IsAjaxRequest) {
                var xUaCompatible = XUACompatibleOverride ?? RuntimePlatformSettings.Misc.XUACompatible.GetValue();
                if (!xUaCompatible.IsEmpty()) {
                    Response.AddHeader("X-UA-Compatible", xUaCompatible);
                }

                if (RuntimePlatformSettings.Security.EnableSecurityFeaturesISA.GetValue()) {
                    var appInfo = AppInfo.GetAppInfo();

                    if (appInfo.IsHSTSEnabled()) {
                        Response.AddHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
                    }

                    // ISA-234: do not send the CSP headers for Non-deployable applications (ServiceCenter, LifeTime, ...)
                    if (appInfo.IsForcingContentSecurityPolicy()) {

                        var base_Uri = appInfo.GetBaseUri();
                        var child_Src = appInfo.GetChildSrc();
                        var connect_Src = appInfo.GetConnectSrc();
                        var default_Src = appInfo.GetDefaultSrc();
                        var font_Src = appInfo.GetFontSrc();
                        var img_Src = appInfo.GetImgSrc();
                        var media_Src = appInfo.GetMediaSrc();
                        var object_Src = appInfo.GetObjectSrc();
                        var plugin_Types = appInfo.GetPluginTypes();
                        var script_Src = appInfo.GetScriptSrc();
                        var style_Src = appInfo.GetStyleSrc();
                        var frame_Ancestors = appInfo.GetFrameAncestors();
                        var report_To = appInfo.GetReportTo();
                        var other = appInfo.GetOtherDirective();

                        if (!report_To.IsEmpty() && report_To.Contains("<internal>")) {

                            var sessionID = appInfo.OsContext.Session.SessionID;
                            var espaceID = appInfo.eSpaceId;
                            var tenantID = appInfo.Tenant.Id;
                            var userID = appInfo.OsContext.Session.UserId;
                            var eSpaceName = appInfo.eSpaceName;
                            var applicationName = appInfo.ApplicationName;
                            var applicationKey = appInfo.ApplicationUID;
                            var username = appInfo.OsContext.Session.UserName;

                            try {
                                var parametersString = String.Join(",", new string[] {
                                    espaceID.ToString(),
                                    tenantID.ToString(),
                                    sessionID,
                                    userID.ToString(),
                                    eSpaceName,
                                    applicationName,
                                    applicationKey,
                                    username
                                });

                                var parametersBytes = AuthenticatedEncryptionWithAssociatedData.Instance.Encrypt(System.Text.Encoding.UTF8.GetBytes(parametersString), null);

                                //eSpaceId, TenantId, SessionId, UserId, EspaceName, ApplicationName, ApplicationKey, Username
                                var querystring = HttpUtility.UrlEncode(Convert.ToBase64String(parametersBytes));
                                var defaultReportURL = "/SecurityUtils/rest/Report/ReportViolations?Params=" + querystring;

                                report_To = report_To.Replace("<internal>", defaultReportURL);
                            } catch (Exception e) {
                                ErrorLog.StaticWrite(DateTime.Now, sessionID, espaceID, tenantID, userID, "An exception has occurred while replacing Content Security Policy " +
                                        "report-to directive value <internal> by its proper URL: " + e.Message + ". This means that the application Content Security Policy reports " +
                                        "will not be logged in Error Log. ", e.StackTrace, moduleName: "CSPReport",
                                        eSpaceName: eSpaceName, applicationName: applicationName, applicationKey: ObjectKey.Parse(applicationKey), username: username);
                            }
                        }
                        
                        var cspHeaderContent =
                                (!base_Uri.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.BaseUri + " " + base_Uri + "; " : "") +
                                (!child_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ChildSource + " " + child_Src + "; " : "") +
                                (!child_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.FrameSource + " " + child_Src + "; " : "") +  //Deprecated. Remove when child-src is compatible with firefox.
                                (!connect_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ConnectSource + " " + connect_Src + "; " : "") +
                                (!default_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.DefaultSource + " " + default_Src + " 'unsafe-inline' 'unsafe-eval'; " : "") +
                                (!font_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.FontSource + " " + font_Src + "; " : "") +
                                (!img_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ImageSource + " " + img_Src + " blob:; " : "") +
                                (!media_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.MediaSource + " " + media_Src + "; " : "") +
                                (!object_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ObjectSource + " " + object_Src + "; " : "") +
                                (!plugin_Types.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.PluginTypes + " " + plugin_Types + "; " : "") +
                                (!script_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ScriptSource + " " + script_Src + " 'unsafe-inline' 'unsafe-eval'; " : "") +
                                (!style_Src.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.StyleSource + " " + style_Src + " 'unsafe-inline'; " : "") +
                                (!frame_Ancestors.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.FrameAncestors + " " + frame_Ancestors + "; " : "") +
                                (!report_To.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ReportUri + " " + report_To + "; " : "") + //Deprecated. Remove when report-to is compatible with all browsers.
                                //(!report_To.IsEmpty() ? RuntimePlatformSettings.ContentSecurityPolicy.Directives.ReportTo + " " + REPORT_TO_HEADER_GROUP_NAME + "; " : "") +
                                (!other.IsEmpty() ? other : "");

                        /*
                        if(!report_To.IsEmpty()) {
                            // If you want to add another url to report, add it to reportToHeader.Endpoints and also in the "report-uri" directive (compatibility reason)
                            Response.AddHeader("Report-To", $"{{'group': '{REPORT_TO_HEADER_GROUP_NAME}','max-age': 31536000,'endpoints': [{{ 'url': '{report_To}' }}]}}");
                        }
                        */

                        List<string> cspHeaders = new List<string>(new string[] { "Content-Security-Policy", "X-Content-Security-Policy", "X-WebKit-CSP" });
                        foreach (string cspHeaderName in cspHeaders) {
                            Response.AddHeader(cspHeaderName, cspHeaderContent);
                        }
                    }
                }

                base.DataBind();
            }

            OnRender();
            NegotiateTabIndexes();
        }
        
        private void OnRender() {
        }

        private void NegotiateTabIndexes() {
        }

        // Fix for stackoverflow on exceptions during DataBind
        protected override void DataBindChildren() {
            if (!HasControls()) {
                return;
            }

            int count = Controls.Count;
            for (int index = 0; index < count; ++index) {
                Controls[index].DataBind();
            }
        }

        public virtual void StoreViewState() {
        }

        /// <summary>
        /// Checks if the current request is an Ajax request
        /// </summary>
        /// <returns></returns>
        public static bool IsAjaxRequest {
            get {
                return AppInfo.GetAppInfo().OsContext.IsAjaxRequest;
            }
        }

        private bool finishedRequest = false;

        public virtual void FinishRequest() {
            if (finishedRequest) {
                return;
            }
            finishedRequest = true;

            if (IsAjaxRequest) {
                FinishAjaxRequest();
            }
        }

        // This is used in java to better control the redirects, just keeping the current behavior
        public void SetFinishedRequest(bool value) {
            finishedRequest = value;
        }

        protected virtual void FinishAjaxRequest() {
            throw new NotImplementedException();
        }

        // for ajax client side redirects
        private string _ajaxRedirectLocation = null;
        protected string AjaxRedirectLocation {
            get {
                return _ajaxRedirectLocation;
            }
            private set {
                _ajaxRedirectLocation = value;
            }
        }

        public void Redirect(string url) {
            try {
                ClearErrorHandler();
                if (IsAjaxRequest) {
                    AjaxRedirectLocation = url;
                    FinishRequest();
                } else {
                    Response.BufferOutput = true;
                    Response.Redirect(url, true);
                }
            } catch (System.Threading.ThreadAbortException) { }
        }

        public void GotoErrorHandlerPage(string url) {
            if (IsAjaxRequest) {
                Redirect(url);
            } else {
                HttpContext.Current.Server.Transfer(url);
            }
        }

        /// <summary>
        /// Renders a specific control returning the rendered HTML
        /// </summary>
        /// <param name="c"></param>
        /// <returns></returns>
        protected string RenderControl(Control c) {
            using (var writer = new StringWriter()) {
                using (var htmlWriter = CreateHtmlTextWriter(writer)) {
                    c.RenderControl(htmlWriter);
                }
                return writer.ToString();
            }
        }

        /// <summary>
        /// Renders the row generated by the last ajax list operation in a list or table record control
        /// </summary>
        /// <param name="c"></param>
        /// <returns></returns>
        protected string RenderAjaxListOperationRow(Control c) {
            return RenderAjaxListOperationRow(c, /*isEmptyMessage*/false, /*rowIndex*/-1);
        }

        /// <summary>
        /// Renders the row generated by the last ajax list operation in a list or table record control
        /// </summary>
        /// <param name="c"></param>
        /// <param name="isEmptyMessage">if this is for rendering the empty message row</param>
        /// <returns></returns>
        protected string RenderAjaxListOperationRow(Control c, bool isEmptyMessage) {
            return RenderAjaxListOperationRow(c, isEmptyMessage, /*rowIndex*/-1);
        }

        /// <summary>
        /// Renders a specific row of a list or table record control
        /// </summary>
        /// <param name="c"></param>
        /// <returns></returns>
        protected string RenderAjaxListOperationRow(Control c, int rowIndex) {
            return RenderAjaxListOperationRow(c, /*isEmptyMessage*/false, rowIndex);
        }

        /// <summary>
        /// Renders a row generated by the last ajax list operation in list or table record control
        /// </summary>
        /// <param name="c"></param>
        /// <param name="isEmptyMessage">if this is for rendering the empty message row</param>
        /// <param name="rowIndex">the index of the row to render, -1 to render the last added / inserted row</param>
        /// <returns></returns>
        private string RenderAjaxListOperationRow(Control c, bool isEmptyMessage, int rowIndex) {
            using (var writer = new StringWriter()) {
                using (var htmlWriter = CreateHtmlTextWriter(writer)) {
                    var list = (IRowRendering)c;

                    if (!isEmptyMessage) {
                        if (rowIndex == -1) {
                            list.RenderLastRow(htmlWriter);
                        } else {
                            list.RenderRow(htmlWriter, rowIndex);
                        }
                    } else {
                        list.RenderEmptyMessage(htmlWriter);
                    }
                }
                return writer.ToString();
            }
        }

        protected override void OnPreRenderComplete(EventArgs e) {
            base.OnPreRenderComplete(e);
            // Notify events must be raised after prerender since some of the target controls might 
            // not be available before such as webblocks inside list records
            if (IsPostBack) {
                RaiseAjaxEvents("Notify");
            }
        }

        protected override void OnLoadComplete(EventArgs e) {
            base.OnLoadComplete(e);
            // the OnLoadComplete event occurs after the RaisePostBack phase. 
            // Since in Ajax we postback to controls that are not supposed to process postbacks
            // (all the ones that support On Click, On Change and On Notify) 
            // We must trigger "manually" the raising of these events in this phase, to mimic the normal click 
            // postbacks of buttons or links, since at this point all the request inputs have been processed
            // Raise only ajax events for Click and Change, Notifies are delayed: see above comment in OnPreRenderComplete
            if (IsPostBack) {
                RaiseAjaxEvents("Click,Change");
            }
        }

        public static Control FindControlRecursive(Control root, string ID) {
            if (root.UniqueID == ID || root.ClientID == ID) {
                return root;
            }

            foreach (Control control in root.Controls) {
                var controlFound = FindControlRecursive(control, ID);
                if (controlFound != null) {
                    return controlFound;
                }
            }
            return null;
        }

        public static IValidationMessages ValidationMessagesInstance;

        public static IValidationMessages ValidationMessages {
            get {
                return ValidationMessagesInstance;
            }
            set {
                ValidationMessagesInstance = value;
            }
        }

        protected string GetMandatoryValidatorMsg() {
            return ValidationMessagesInstance.MandatoryValidatorMsg;
        }

        protected string GetIntegerValidatorMsg() {
            return ValidationMessagesInstance.IntegerValidatorMsg;
        }

        protected string GetDecimalValidatorMsg() {
            return ValidationMessagesInstance.DecimalValidatorMsg;
        }

        protected string GetCurrencyValidatorMsg() {
            return ValidationMessagesInstance.CurrencyValidatorMsg;
        }

        protected string GetDateValidatorMsg() {
            return ValidationMessagesInstance.DateValidatorMsg;
        }

        protected string GetTimeValidatorMsg() {
            return ValidationMessagesInstance.TimeValidatorMsg;
        }

        protected string GetDateTimeValidatorMsg() {
            return ValidationMessagesInstance.DateTimeValidatorMsg;
        }

        protected string GetTextValidatorMsg() {
            return ValidationMessagesInstance.TextValidatorMsg;
        }

        protected string GetPhoneNumberValidatorMsg() {
            return ValidationMessagesInstance.PhoneNumberValidatorMsg;
        }

        protected string GetNumericPasswordValidatorMsg() {
            return ValidationMessagesInstance.NumericPasswordValidatorMsg;
        }

        protected string GetEmailValidatorMsg() {
            return ValidationMessagesInstance.EmailValidatorMsg;
        }

        /// <summary>
        /// Raises the ajax event in the request if present
        /// </summary>
        protected void RaiseAjaxEvents(string eventTypes) {
            string ajaxEvent = Request.Form["__AJAXEVENT"];
            if (ajaxEvent != null && eventTypes.Contains(ajaxEvent)) {
                string eventTarget = Request.Form["__EVENTTARGET"];
                var target = FindControlRecursive(this, eventTarget);

                // if target is not found, do nothing. Error message in the future?
                if (target == null) {
                    return;
                }

                // forward events...
                if (ajaxEvent == "Notify") {
                    ((IAjaxNotifyEvent)target).OnAjaxNotify(new EventArgs());
                } else if (ajaxEvent == "Click") {
                    ((IAjaxClickEvent)target).OnAjaxClick(new EventArgs());
                } else if (ajaxEvent == "Change") {
                    ((IAjaxChangeEvent)target).OnAjaxChange(new EventArgs());
                }
            }
        }

        private Dictionary<Control, Control> _registeredValidationControls = new Dictionary<Control, Control>();

        public void RegisterValidationControlOrder(Control controlToValidate) {
            if (!_registeredValidationControls.ContainsKey(controlToValidate)) {
                Page.ClientScript.RegisterArrayDeclaration("OsPage_ValidatorsOrder", "\"" + controlToValidate.ClientID + "\"");
                _registeredValidationControls.Add(controlToValidate, controlToValidate);
            }
        }

        #region IVarsBag Members

        protected VarsBag localVars = new VarsBag();

        public override void EvaluateFields(VarValue variable, object parent, string baseName, string fields) {
            localVars.EvaluateFields(variable, parent, baseName, fields);
        }

        public override object GetVariableValue(string varName) {
            return localVars.GetVariableValue(varName);
        }

        public override bool HasVariable(string varName) {
            return localVars.HasVariable(varName);
        }

        public override void ToXml(object parent, System.Xml.XmlElement baseElem, string fieldName, int detailLevel) {
            localVars.ToXml(parent, baseElem, fieldName, detailLevel);
        }

        public override string[] VarNames {
            get { return localVars.VarNames; }
        }

        public override void SetNewOrigin(object origin) {
            localVars.SetNewOrigin(origin);
        }

        public override void InitVars(string[] varNames, string[] varRtNames) {
            localVars.InitVars(varNames, varRtNames);
            SetNewOrigin(this);
        }

        #endregion

        public virtual void ClearErrorHandler() { }

        public virtual string ReplaceBasePath(string path) {
            return path.Replace("~/", GetAppUtils().getImagePath());
        }

        private string inlineCss;

        protected virtual string GetInlineCss() {
            return GetInlineCss(null);
        }

        protected virtual string GetInlineCss(string hostName) {
            if (inlineCss == null) {
                var flattened = new HashSet<string>();

                inlineCss = AddLocalInlineCss(BasicCssFile, "", flattened, hostName);

                using (var localCssWriter = new StringWriter()) {
                    GetBlocksCss(localCssWriter, /*inline*/true, new HashSet<string>());
                    GetWidgetsCss(localCssWriter, /*inline*/true, new HashSet<string>());
                    inlineCss += localCssWriter.ToString();
                }

                inlineCss = AddLocalInlineCss(ThemeCssFile, inlineCss, flattened, hostName);
                inlineCss = AddLocalInlineCss(OwnCssFile, inlineCss, flattened, hostName);
                inlineCss = AddLocalInlineCss(ThemeExtraCssFile, inlineCss, flattened, hostName);
            }
            return inlineCss;
        }

        protected virtual string GetInlineStyleSheetInclude() {
            string css = GetInlineCss();
            if (string.IsNullOrEmpty(css)) {
                return string.Empty;
            }
            return "<style>" + Environment.NewLine + css + Environment.NewLine + "</style>";
        }

        protected virtual string GetUrlPrefix(out bool prefixWithImagePath) {
            string osPageHeader = AppInfo.GetAppInfo().OsContext.OsISAPIFilter.GetPage();
            prefixWithImagePath = osPageHeader != null && osPageHeader.IndexOf('/', 1) != -1;
            return prefixWithImagePath ? GetAppUtils().getImagePath() : null;
        }

        protected void WriteStyleSheetLink(TextWriter writer, string url) {
            bool prefixWithImagePath;
            var urlPrefix = GetUrlPrefix(out prefixWithImagePath);
            var stylesheetLink = GetStyleSheetLink(url, prefixWithImagePath, urlPrefix);
            if (!stylesheetLink.IsEmpty()) {
                writer.WriteLine(stylesheetLink);
            }
        }

        protected string GetStyleSheetLink(string url, bool prefixWithImagePath, string prefix) {
            return GetStyleSheetLink(url, prefixWithImagePath, prefix, GetAppUtils().CacheInvalidationSuffix);
        }

        protected string GetStyleSheetLink(string url, bool prefixWithImagePath, string prefix, string cacheInvalidationSuffix) {
            string realUrl = url;
            if (!realUrl.IsEmpty()) {
                // i370377 - checks if the theme is external it don't need the local prefix 
                if (realUrl.StartsWith("/") || realUrl.StartsWith("http://") || realUrl.StartsWith("https://")) {
                    prefixWithImagePath = false;
                }
                if (prefixWithImagePath) {
                    realUrl = prefix + realUrl;
                }
                return "    " + CssHelper.GetCssInclude(realUrl + cacheInvalidationSuffix);
            }
            return null;
        }

        protected virtual string InnerGetStyleSheetIncludes() {
            using (var localCssWriter = new StringWriter()) {
                // for enhanced perfomance inline basic.css (since its supposed to be small)
                var basicCss = AddLocalInlineCss(BasicCssFile, "", new HashSet<string>());
                localCssWriter.WriteLine("<style>");
                localCssWriter.WriteLine(basicCss);
                localCssWriter.WriteLine("</style>");

                var visitedBlocksOrWidgets = new HashSet<string>();
                GetBlocksCss(localCssWriter, /*inline*/false, visitedBlocksOrWidgets);
                GetWidgetsCss(localCssWriter, /*inline*/false, visitedBlocksOrWidgets);
                GetExtraStyleSheetIncludes(localCssWriter);

                return localCssWriter.ToString();
            }
        }

        protected virtual void GetExtraStyleSheetIncludes(TextWriter writer) {
            bool prefixWithImagePath;
            string prefix = GetUrlPrefix(out prefixWithImagePath);

            string link = GetStyleSheetLink(ThemeCssUrl, prefixWithImagePath, prefix, ThemeCssCacheInvalidationSuffix);
            if (!link.IsEmpty()) {
                writer.WriteLine(link);
            }

            link = GetStyleSheetLink(OwnCssUrl, prefixWithImagePath, prefix);
            if (!link.IsEmpty()) {
                writer.WriteLine(link);
            }

            link = GetStyleSheetLink(ThemeExtraCssUrl, prefixWithImagePath, prefix, ThemeExtraCssCacheInvalidationSuffix);
            if (!link.IsEmpty()) {
                writer.WriteLine(link);
            }
        }

        protected string styleSheetIncludes;

        protected string GetStyleSheetIncludes() {
            if (styleSheetIncludes == null) {
                styleSheetIncludes = InnerGetStyleSheetIncludes();
            }
            return styleSheetIncludes;
        }

        protected virtual string GetJavaScriptIncludes() {
            using (var writer = new StringWriter()) {
                foreach (string template in GetAppUtils().GetAjaxJQueryFileNames()) {
                    writer.WriteLine("    <script src=\"" + template + GetAppUtils().CacheInvalidationPlatformSuffix + "\" type=\"text/javascript\" charset=\"UTF-8\"></script>");
                }

                string javaScriptInclude = GetAppUtils().GetGlobalJavaScriptInclude();
                if (!string.IsNullOrEmpty(javaScriptInclude)) {
                    writer.WriteLine("    " + javaScriptInclude);
                }

                BlocksJavaScript.WriteBlockJavaScriptIncludes(writer);

                string screenJavaScript = OwnJavascriptInclude;
                if (!string.IsNullOrEmpty(screenJavaScript)) {
                    writer.WriteLine("    " + screenJavaScript);
                }

                writer.WriteLine();
                return writer.ToString();
            }
        }

        protected virtual bool PageAllowsCallbacks() {
            return false; // Webscreen might redifine this value
        }

        protected string GetInjectedCode(CodeInjectionFactory.Locations position, string webScreenKey, string webScreenName) {
            return AppInfo.GetAppInfo().GetInjectedContent(position, PageAllowsCallbacks(), webScreenKey, webScreenName);
        }

        protected virtual string GetRequestInfoJavaScript(string webScreenKey, string webScreenName) {
            var info = AppInfo.GetAppInfo();
            using (var writer = new StringWriter()) {
                writer.Write("    <script id=\"_OSrequestInfoScript\" type=\"text/javascript\">(function(global) { ");
                writer.Write("global.outsystems = global.outsystems || {};");
                writer.Write("global.outsystems.internal = global.outsystems.internal || {};");
                if (RuntimePlatformSettings.Misc.JavascriptAPI_ShowHiddenFields.GetValue()) {
                    writer.Write("global.outsystems.internal.showHiddenFields = true;");
                }
                writer.Write("global.outsystems.internal.requestInfo = {");
                //  #564602 OSVisit and OSVisitor cookies allow HTML injection -check if cookies' value  was modified
                writer.Write("visitorKey:'{0}',", BuiltInFunction.EncodeJavascript((GuidUtils.IsGuid(info.VisitorId) ? info.VisitorId : "") ?? ""));
                writer.Write("visitKey:'{0}',", BuiltInFunction.EncodeJavascript((GuidUtils.IsGuid(info.VisitId) ? info.VisitId : "") ?? ""));
                writer.Write("sessionKey:'{0}',", BuiltInFunction.EncodeJavascript((info.OsContext.Session.SessionIDHash) ?? ""));
                writer.Write("userKey:'{0}',", BuiltInFunction.EncodeJavascript((info.OsContext.Session.UserIdGuid) ?? ""));

                var perfTracer = info.OsContext.RequestTracer;
                bool perfTracerExists = perfTracer != null;

                writer.Write("requestKey:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.RequestKey : "") ?? ""));
                writer.Write("webScreenKey:'{0}',", BuiltInFunction.EncodeJavascript((ObjectKeyUtils.DatabaseValue(ObjectKey.Parse(webScreenKey))) ?? ""));
                writer.Write("webScreenName:'{0}',", BuiltInFunction.EncodeJavascript((webScreenName) ?? ""));
                writer.Write("espaceKey:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.ModuleKey : info.eSpaceUID) ?? ""));
                writer.Write("espaceName:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.ModuleName : info.eSpaceName) ?? ""));
                writer.Write("applicationKey:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.ApplicationKey : info.ApplicationUID) ?? ""));
                writer.Write("applicationName:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.ApplicationName : info.ApplicationName) ?? ""));
                writer.Write("tenantKey:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.TenantKey : info.Tenant.Id_Guid) ?? ""));
                writer.Write("tenantName:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.TenantName : info.Tenant.Name) ?? ""));
                writer.Write("environmentKey:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.EnvironmentKey : info.EnvironmentKey) ?? ""));
                writer.Write("environmentName:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.EnvironmentName : info.EnvironmentName) ?? ""));
                if (RuntimePlatformSettings.Misc.JavascriptAPI_ShowHiddenFields.GetValue()) {
                    writer.Write("username:'{0}',", BuiltInFunction.EncodeJavascript((info.OsContext.Session.UserName) ?? ""));
                    writer.Write("frontendName:'{0}',", BuiltInFunction.EncodeJavascript(((perfTracerExists) ? perfTracer.FrontEndName : info.FrontendName) ?? ""));
                }
                // #664816 - When the host serial on OSSYS_SERVER is different from the one in the windows registry the FrontendName will not be read from the DB.
                // We do a null check here to prevent this not vital information from stopping the application load.
                string value = null;
                if (perfTracerExists) {
                    value = string.IsNullOrEmpty(perfTracer.FrontEndName) ? "" :
                    SecureConfidentialInformationEncryption.EncryptWithAlgorithm(perfTracer.FrontEndName, SecureConfidentialInformationEncryption.FixedKeyAES128.Instance);
                } else {
                    value = string.IsNullOrEmpty(info.FrontendName) ? "" :
                    SecureConfidentialInformationEncryption.EncryptWithAlgorithm(info.FrontendName, SecureConfidentialInformationEncryption.FixedKeyAES128.Instance);
                }
                writer.Write("frontendKey:'{0}'", BuiltInFunction.EncodeJavascript((value) ?? ""));
                writer.Write("}");
                writer.Write("})(this);");
                writer.Write("</script>\n");
                return writer.ToString();
            }
        }

        protected string bookmarkableUrl;
        
        public override string GetBookmarkableURL() {
            return bookmarkableUrl;
        }

        protected string actionUrl;
        public override string GetFormAction() {
            return actionUrl;
        }

        protected virtual BaseAppUtils GetAppUtils() {
            throw new NotImplementedException();
        }

        protected virtual string OwnCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string OwnCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string BasicCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string BasicCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ServiceCenterBrandingCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ServiceCenterBrandingCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string LifeTimeCoreBrandingCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string LifeTimeCoreBrandingCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string LifeTimePerformanceMonitorBrandingCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string LifeTimePerformanceMonitorBrandingCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string PerformanceThemeBrandingCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string PerformanceThemeBrandingCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string LifeTimeStyleBrandingCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string LifeTimeStyleBrandingCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ThemeCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ThemeCssCacheInvalidationSuffix {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ThemeCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ThemeExtraCssUrl {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ThemeExtraCssCacheInvalidationSuffix {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string ThemeExtraCssFile {
            get {
                throw new NotImplementedException();
            }
        }

        protected virtual string OwnJavascriptInclude {
            get {
                throw new NotImplementedException();
            }
        }

        public virtual string XUACompatibleOverride {
            get {
                return null;
            }
        }

        protected virtual void GetBlocksCss(TextWriter writer, bool inline, HashSet<string> visited) {
            throw new NotImplementedException();
        }

        protected virtual void GetWidgetsCss(TextWriter writer, bool inline, HashSet<string> visited) {
            throw new NotImplementedException();
        }

        public virtual LocalState[] PopDebuggerState() {
            return null;
        }

        #region IScreen members

        public virtual Control FindControlByName(string name) {
            return null;
        }
        #endregion

        [Obsolete("Use GetClientRedirectionUrlBasePath instead")]
        public virtual string GetRedirectionProtocol(bool destinationIsSecure) {
            if (destinationIsSecure || RuntimePlatformUtils.RequestIsHttps(Request)) {
                return Uri.UriSchemeHttps + Uri.SchemeDelimiter;
            } else {
                return Uri.UriSchemeHttp + Uri.SchemeDelimiter;
            }
        }
        
        public virtual string GetClientRedirectionUrlBasePath(bool destinationIsSecure, string urlPath, string defaultPortPart = "", string securePortPart = "") {
            string host = (EmailScreenUtils.SafeGetEmailHost(Page as IEmailScreen) ?? Request.Url.Host);

            string protocolSnippet;
            string portSnippet = "";

            if (destinationIsSecure || RuntimePlatformUtils.RequestIsHttps(Request)) {
                protocolSnippet = Uri.UriSchemeHttps + Uri.SchemeDelimiter;
                portSnippet = securePortPart;
            } else {
                protocolSnippet = Uri.UriSchemeHttp + Uri.SchemeDelimiter;
                portSnippet = defaultPortPart;
            }

            return protocolSnippet + host + portSnippet + urlPath;
        }

        protected void WriteEmailExceptionInformation(HtmlTextWriter writer, Exception e) {
            writer.Write("<ExceptionMessage>" + e.Message + "</ExceptionMessage>");
            writer.Write("<ExceptionStackTrace>" + e.StackTrace + "</ExceptionStackTrace>");
        }

        // for webblock stack viewstate management
        private HashSet<IObjectWithViewState> _viewStateObjecsStack = new HashSet<IObjectWithViewState>();

        public void StoreWebScreenStackViewState() {
            var webscreens = _viewStateObjecsStack.SafeToList();
            foreach (IObjectWithViewState webscreen in webscreens) {
                webscreen.StoreViewState();
            }
        }

        public virtual void AddStoreViewStateWebScreenStack(IObjectWithViewState viewStateObjec) {
            if (!_viewStateObjecsStack.Contains(viewStateObjec)) {
                _viewStateObjecsStack.Add(viewStateObjec);
            }
        }

        public virtual void RemoveStoreViewStateWebScreenStack(IObjectWithViewState viewStateObjec) {
            if (_viewStateObjecsStack.Contains(viewStateObjec)) {
                _viewStateObjecsStack.Remove(viewStateObjec);
            }
        }
    }
}