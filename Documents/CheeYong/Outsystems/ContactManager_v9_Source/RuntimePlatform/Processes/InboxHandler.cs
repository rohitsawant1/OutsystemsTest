/* 
 This source code (the "Generated Software") is generated by the OutSystems Platform 
 and is licensed by OutSystems (http://www.outsystems.com) to You solely for testing and evaluation 
 purposes, unless You and OutSystems have executed a specific agreement covering the use terms and 
 conditions of the Generated Software, in which case such agreement shall apply. 
*/

using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Runtime.CompilerServices;
using System.Web;
using OutSystems.HubEdition.RuntimePlatform.Callbacks;
using OutSystems.HubEdition.RuntimePlatform.Db;
using OutSystems.Internal.Db;
using OutSystems.ObjectKeys;
using OutSystems.RuntimeCommon;

namespace OutSystems.HubEdition.RuntimePlatform.Processes {
    
    public class InboxHandler : ILibraryCallbackHandler {

        public string GetDynamicHtmlInjection(AppInfo app, SessionInfo session, string locale, string data) {
            int userId = (session != null ? session.UserId : 0);
            ObjectKey userProviderEspaceKey = (HttpContext.Current != null ? app.UserProviderEspaceKeyAsKey : null);

            if (userId == BuiltInFunction.NullIdentifier()) {
                return string.Empty;
            }

            InboxQueries.PaginationInfo? inboxActivityCount;

            // Check if the User Providers are shared between the Inbox and the current eSpace
            if (!RuntimePlatformSettings.Module.HasEPAEnabled.GetValue()) {
                return string.Empty;
            }

            using (Transaction trans = DatabaseAccess.ForRuntimeDatabase.GetRequestTransaction()) {
                inboxActivityCount = InboxQueries.GetActivityCount(trans, userId);
            }

            if (!inboxActivityCount.HasValue) {
                throw new DataBaseException("No activity data found for userId = " + userId);
            }

            return "<script type='text/javascript'> EPATaskbox.instance = new EPATaskbox(outsystems.internal.$('.EPATaskbox_Container'), " + userId +
                ", " + inboxActivityCount.Value.Total + ", " + (inboxActivityCount.Value.Unseen > 0 ? "true" : "false") +
                ", null); </script>";
        }
	}
}