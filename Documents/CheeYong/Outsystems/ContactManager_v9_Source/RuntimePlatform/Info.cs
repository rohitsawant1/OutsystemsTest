/* 
 This source code (the "Generated Software") is generated by the OutSystems Platform 
 and is licensed by OutSystems (http://www.outsystems.com) to You solely for testing and evaluation 
 purposes, unless You and OutSystems have executed a specific agreement covering the use terms and 
 conditions of the Generated Software, in which case such agreement shall apply. 
*/

using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading;
using System.Web;
using System.Web.Caching;
using System.Web.Services.Protocols;
using OutSystems.HubEdition.RuntimePlatform.Callbacks;
using OutSystems.HubEdition.RuntimePlatform.Log;
using OutSystems.HubEdition.RuntimePlatform.NewRuntime.Authentication;
using OutSystems.Internal.Db;
using OutSystems.ObjectKeys;
using OutSystems.RuntimeCommon;
using OutSystems.RuntimeCommon.Cryptography.Insecure;
using OutSystems.RuntimeCommon.Log;
using OutSystems.Logging.LogDefinition;
using OutSystems.RuntimeCommon.Caching;
using OutSystems.HubEdition.RuntimePlatform.Licensing;

namespace OutSystems.HubEdition.RuntimePlatform {

    public enum EndUserAction {
        Create,
        Update,
        CreateOrUpdate,
        Get,
        GetForUpdate,
        Delete,
    }

    public class ExtensionPropertiesCache {
        private Dictionary<string, Dictionary<string, string>> ext_propCache = new Dictionary<string, Dictionary<string, string>>();
        private AppInfo m_parentInfo = null;
        private bool dirty = false;

        public bool AllowLogging(string extensionKey) {
            return getPropertyVal(extensionKey, "AllowLogging").ToLower() == "true";
        }

        private string getPropertyVal(string extensionKey, string propertyName) {
            lock (this) {
                if (dirty) {
                    this.ClearExtensionProperties();
                    //initCache();
                    dirty = false;
                }
            }
            Dictionary<string, string> ep;
            lock (this) {
                if (!ext_propCache.TryGetValue(extensionKey, out ep)) {
                    ep = new Dictionary<string, string>();
                    ext_propCache.Add(extensionKey, ep);
                }
            }
            if (!ep.ContainsKey(propertyName)) {
                string propSettingDefValue = "true";
                RuntimeSetting<string> propSetting = RuntimePlatformSettings.Module.ForKey(ObjectKey.Parse(extensionKey)).ForSetting<string>(propertyName, propSettingDefValue);
                string val = RuntimeSettingsProvider.Instance.Get<string>(propSetting);

                lock (ep) {
                    ep[propertyName] = val;
                }
            }
            return ep[propertyName];
        }

        public ExtensionPropertiesCache(AppInfo parentInfo) {
            m_parentInfo = parentInfo;
            initCache();
        }

        private void initCache() {
            RuntimeCache.Instance.Listen(
                            new CacheKey("ExtensionPropertiesRemCondition" + m_parentInfo.eSpaceId),
                            new EspaceTenantDependency(m_parentInfo.eSpaceId, 0),
                            extensionPropertiesRemovedCallback);
        }

        private void extensionPropertiesRemovedCallback() {
            lock (this) {
                dirty = true;
            }
        }

        public void ClearExtensionProperties() {
            if (ext_propCache != null) {
                ext_propCache.Clear();
            }
        }
    }

    public class EspaceProperties {
        public bool AllowAuditing {
            get {
                return RuntimePlatformSettings.Module.AllowAuditing.GetValue();
            }
        }

        public bool AllowLogging {
            get {
                return RuntimePlatformSettings.Module.AllowLogging.GetValue();
            }
        }

        public bool ClientSideTracingEnabled {
            get {
                return OSTrace.getRealLogLevel().TraceVerbose || RuntimePlatformSettings.Debug.ForceClientSideTracing.GetValue();
            }
        }

        public bool RemoteShowStack {
            get {
                return RuntimePlatformSettings.Module.RemoteShowStack.GetValue();
            }
        }

        public string DefaultDnsName {
            get {
                return RuntimePlatformSettings.EMail.DefaultDnsName.GetValue();
            }
        }

        public bool EnableEmails {
            get {
                return RuntimePlatformSettings.EMail.EnableEmails.GetValue();
            }
        }

        public bool EspaceApplicationEnabled {
            get {
                return RuntimePlatformSettings.Application.Enabled.GetValue();
            }
        }

        public string TestEmails {
            get {
                return RuntimePlatformSettings.EMail.TestEmails.GetValue();
            }
        }

        public bool PerformanceMonitoringEnabled {
            get {
                return RuntimePlatformSettings.Module.PerformanceMonitoringEnabled.GetValue();
            }
        }
    }

    /// <summary>
    /// Contains all the information about the tenant.
    /// </summary>
    public class TenantInfo {
        private int _tenantId;

        private string _tenantName;

        private bool _tenantActive;

        private AppInfo _parentApp;

        private static volatile Hashtable locker = Hashtable.Synchronized(new Hashtable());
        protected object GetLockForTenant(int tenantId) {
            if (!locker.ContainsKey(tenantId)) {
                lock (locker) {
                    if (!locker.ContainsKey(tenantId)) {
                        locker.Add(tenantId, new object());
                    }
                }
            }
            return locker[tenantId];
        }

        protected volatile bool IsTenantInfoValid = false;

        public AppInfo App {
            get {
                return _parentApp;
            }
        }

        public int Id {
            get {
                return _tenantId;
            }
        }

        private string _tenantIdGuid;
        public string Id_Guid {
            get {
                if (_tenantIdGuid == null) {
                    _tenantIdGuid =
                        MD5GuidHelper.ToGuidWithSaltAndUTF16(_tenantId.ToString(CultureInfo.InvariantCulture), SharedKeys.PrivateSalt()).ToString();
                }
                return _tenantIdGuid;
            }
        }

        public string Name {
            get {
                return _tenantName;
            }
        }

        public bool IsActive {
            get {
                if (!IsTenantInfoValid) {
                    lock (GetLockForTenant(this.Id)) {
                        if (!IsTenantInfoValid) {
                            using (Transaction trans = DatabaseAccess.ForRuntimeDatabase.GetCommitableTransaction()) {
                                _tenantActive = DBRuntimePlatform.Instance.GetTenantActive(trans, _tenantId);
                            }
                            IsTenantInfoValid = true;
                        }
                    }
                }
                return _tenantActive;
            }
        }

        public SitePropertiesInfo SiteProperties {
            get {
                //_siteProperties.SitePropertiesInvalidated += new SitePropertiesInfoEventHandler(OnSitePropertiesInvalidated);
                return _parentApp.Espace(_parentApp.eSpaceId).EspaceSiteProperties;
            }
        }

        public TenantInfo(int tenantId, AppInfo appInfo) {
            _parentApp = appInfo;

            using (Transaction trans = DatabaseAccess.ForRuntimeDatabase.GetReadOnlyTransaction()) {
                if (tenantId <= 0) {
                    throw (new ArgumentException("Invalid tenant ID given"));
                }
                // Get the tenant info
                _tenantId = 0;
                for (int retry = 3; retry > 0; retry--) {
                    using (IDataReader reader = DBRuntimePlatform.Instance.GetTenantInfo(trans, tenantId)) {
                        if (reader.Read()) {
                            _tenantActive = Convert.ToBoolean(reader["Is_Active"]);
                            _tenantName = (string)reader["Name"];
                            _tenantId = Convert.ToInt32(reader["Id"]);
                            IsTenantInfoValid = true;
                            break;
                        }
                    }
                    Thread.Sleep(500);
                }

                if (_tenantId == 0) {
                    // Possibly the dreaded "_t0" error
                    string message = String.Format("Could not fetch Tenant Info from DB for tenant '{0}'", _tenantName);
                    throw new InvalidOperationException(message);
                }
            }

            initCache();
        }

        private bool inInitCache = false;

        private void initCache() {
            lock (GetLockForTenant(this.Id)) {
                if (inInitCache) {
                    return;
                } else {
                    inInitCache = true;
                }
                var dependency = new RuntimeCommon.Caching.AggregateCacheDependency(
                    new EspaceTenantDependency(0, _tenantId), 
                    new EspaceTenantDependency(_parentApp.eSpaceId, 0));

                RuntimeCache.Instance.Listen(
                            new CacheKey("tenantInfoRemCondition" + _tenantId),
                            dependency,
                            TenantInfoRemovedCallback);
            }
        }

        private void TenantInfoRemovedCallback() {
            lock (GetLockForTenant(this.Id)) {
                IsTenantInfoValid = false;
            }
        }
    }

    /// <summary>
    /// This class is used to store information about the Ajax event triggered by the client
    /// </summary>
    public class AjaxEventContextInfo {
        private int _documentWidth;
        private int _documentHeight;
        private string _elementId;
        private int _elementOffsetTop;
        private int _elementOffsetLeft;
        private int _scrollOffsetTop;
        private int _scrollOffsetLeft;
        private int _mouseX;
        private int _mouseY;
        private string _notifyMessage;

        /// <summary>
        /// Builds an empty AjaxEventContextInfo
        /// </summary>
        public AjaxEventContextInfo() {
            _documentWidth = 0;
            _documentHeight = 0;
            _elementId = "";
            _elementOffsetTop = 0;
            _elementOffsetLeft = 0;
            _scrollOffsetTop = 0;
            _scrollOffsetLeft = 0;
            _mouseX = 0;
            _mouseY = 0;
            _notifyMessage = "";
        }

        /// <summary>
        /// Builds the AjaxEventContentInfo based on the ajax request value
        /// </summary>
        /// <param name="ajaxRequestArgs"></param>
        public AjaxEventContextInfo(string ajaxRequestArgs) {
            string[] args = ajaxRequestArgs.Split(',');
            _documentWidth = Int32.Parse(args[0]);
            _documentHeight = Int32.Parse(args[1]);
            _elementId = args[2];
            _elementOffsetTop = Int32.Parse(args[3]);
            _elementOffsetLeft = Int32.Parse(args[4]);
            _scrollOffsetTop = Int32.Parse(args[5]);
            _scrollOffsetLeft = Int32.Parse(args[6]);
            _mouseX = Int32.Parse(args[7]);
            _mouseY = Int32.Parse(args[8]);

            // get the notify argument
            System.IO.StringWriter writer = new StringWriter();
            for (int i = 9; i < args.Length; i++) {
                if (i > 9)
                    writer.Write(',');
                writer.Write(args[i]);
            }
            _notifyMessage = writer.ToString();
        }


        /// <summary>
        /// The document element width property
        /// </summary>
        public int DocumentWidth {
            get {
                return _documentWidth;
            }
        }

        /// <summary>
        /// The document element heigth property
        /// </summary>
        public int DocumentHeight {
            get {
                return _documentHeight;
            }
        }

        /// <summary>
        /// The id of the element that triggered the event
        /// </summary>
        public string ElementId {
            get {
                return _elementId;
            }
        }

        /// <summary>
        /// The absolute vertical position of the element that triggered the event
        /// </summary>
        public int ElementOffsetTop {
            get {
                return _elementOffsetTop;
            }
        }

        /// <summary>
        /// The absolute horizontal position of the element that triggered the event
        /// </summary>
        public int ElementOffsetLeft {
            get {
                return _elementOffsetLeft;
            }
        }

        /// <summary>
        /// The vertical viewport position
        /// </summary>
        public int ScrollOffsetTop {
            get {
                return _scrollOffsetTop;
            }
        }

        /// <summary>
        /// The horizontal viewport position
        /// </summary>
        public int ScrollOffsetLeft {
            get {
                return _scrollOffsetLeft;
            }
        }

        /// <summary>
        /// The absolute horizontal mouse position
        /// </summary>
        public int MouseX {
            get {
                return _mouseX;
            }
        }


        /// <summary>
        /// The absolute vertical mouse position 
        /// </summary>
        public int MouseY {
            get {
                return _mouseY;
            }
        }

        /// <summary>
        /// The text message used while invoking the notify method.
        /// </summary>
        public string NotifyMessage {
            get {
                return _notifyMessage;
            }
            set {
                _notifyMessage = value;
            }
        }

        /// <summary>
        /// Gets the Ajax event context info of a given context
        /// </summary>
        /// <param name="context"></param>
        /// <returns>A new instance of an AjaxEventContextInfo.</returns>
        [System.Diagnostics.DebuggerNonUserCode]
        public static AjaxEventContextInfo GetAjaxEventContextInfo(HttpContext context) {
            // get the ajax request value
            string ajaxRequestArgs = null;

            if (ValidRequestForAjax(context)) {
                try {
                    ajaxRequestArgs = context.Request.Form["__AJAX"];
                } catch { }
            }

            if (ajaxRequestArgs != null) {
                // this is an Ajax request
                try {
                    return new AjaxEventContextInfo(ajaxRequestArgs);
                } catch (Exception e) {
                    var appInfo = AppInfo.GetAppInfo(context);
                    Log.ErrorLog.LogApplicationError(e.Message, e, null, "RuntimePlatform");
                    return new AjaxEventContextInfo();
                }
            } else {
                // no ajax event context for non-ajax requests
                return new AjaxEventContextInfo();
            }
        }

        private static bool ValidRequestForAjax(HttpContext context) {
            return true;
        }

    }

    /// <summary>
    /// Class that is is used to store the information about the application.
    /// THIS CLASS IS USED EXTERNALLY. WE CANNOT BREAK THIS INTERFACE.
    /// </summary>
    // DO NOT REMOVE sealed qualifier
    public sealed class AppInfo : IAppInfo, IMobileLoginCookieNamer, IDisposable {
        private const string APP_CACHE_FILE_PREFIX = "appCacheFile_";

        private readonly int _eSpaceId;

        private readonly string _catalogName;

        private readonly Dictionary<string, object> _dataBaseConfigurationDetails;

        private readonly ObjectKey _eSpaceUID;

        private readonly string _eSpaceName;

        private readonly int _eSpaceVersionId;

        private JQueryVersion _jQueryVersion;

        private readonly string _frontendName;

        private readonly string _environmentKey;

        private readonly string _environmentName;

        private readonly string _cacheInvalidationURLSuffix;

        private readonly bool _isMultitenant;

        private readonly bool _isMobileRuntime;

        private readonly Hashtable _tenants = Hashtable.Synchronized(new Hashtable());

        private readonly ObjectKey _userProviderEspaceKey;
        
        private readonly string _userProviderName;

        private readonly int _defaultTenantId;

        private readonly object _injectionCacheLockingObject = new object();

        private readonly static object _scIdLockingObject = new object();

        private volatile InjectionCache _injectionCache = null;

        private bool _needsToTouchSC = false;

        private volatile Callbacks.CallbackResultStorage _callbackStorage = null;
        public readonly EspaceProperties Properties;

        public readonly ExtensionPropertiesCache ExtensionProperties;

        private readonly LicenseParameters LicenseParameters;

        private volatile Dictionary<int, EspaceInfo> _espaces = new Dictionary<int, EspaceInfo>();

        private readonly object _mobileLoginConfigLockingObject = new object();

        public EspaceInfo Espace(int espaceId) {
            EspaceInfo espaceInfo;
            if (!_espaces.TryGetValue(espaceId, out espaceInfo)) {
                lock (_espaces) {
                    if (!_espaces.TryGetValue(espaceId, out espaceInfo)) {
                        espaceInfo = new EspaceInfo(espaceId, this);
                        _espaces[espaceId] = espaceInfo;
                    }
                }
            }
            return espaceInfo;
        }

        // SEO information

        private Dictionary<string, string> DBGetESpacePrettyNames() {
            Dictionary<string, string> _PrettyNameCache = new Dictionary<string, string>();

            using (Transaction trans = DatabaseAccess.ForRuntimeDatabase.GetReadOnlyTransaction()) {
                using (IDataReader reader = DBRuntimePlatform.Instance.GetEspacePrettyNames(trans)) {
                    while (reader.Read()) {
                        _PrettyNameCache[((string)reader["Translation"]).Substring(1).ToLower()] =
                            ((string)reader["Incoming"]) + "/";
                    }
                }
            }
            return _PrettyNameCache;
        }


        private Dictionary<string, List<string>> DBGetPageRules(int eSpaceId) {

            Dictionary<string, List<string>> _PageRulesCache = new Dictionary<string, List<string>>();

            using (Transaction tran = DatabaseAccess.ForRuntimeDatabase.GetReadOnlyTransaction()) {
                using (IDataReader reader = DBRuntimePlatform.Instance.GetPageRules(tran, eSpaceId)) {
                    while (reader.Read()) {
                        string targetPage = (string)reader["TargetPage"];
                        if (!_PageRulesCache.ContainsKey(targetPage)) {
                            _PageRulesCache.Add(targetPage, new List<string>());
                        }
                        _PageRulesCache[targetPage].Add((string)reader["Incoming"]);
                    }
                }
            }
            return _PageRulesCache;
        }

        public Dictionary<string, List<string>> GetPageRules(int eSpaceId) {
            Func<int, Dictionary<string, List<string>>> rules = DBGetPageRules;
            return AppCache.GetESpaceCachedValue(eSpaceId, "PageRules", ServiceCenterId, rules);
        }

        public Dictionary<string, string> GetESpacePrettyNames() {
            return AppCache.GetESpaceCachedValue<Dictionary<string, string>>("PrettyNameCache", ServiceCenterId, DBGetESpacePrettyNames);
        }

        public static int ServiceCenterId {
            get {
                return RuntimePlatformSettings.Environment.ServiceCenterId.GetValue();
            }
        }


        // The user variables
        private Hashtable _variables = new Hashtable();

        public object this[string name] {
            get {
                if (_variables[name] == null) {
                    return null;
                }
                return _variables[name];
            }
            set {
                _variables[name] = value;
            }
        }

        #region Activation

        #region Development Limitations

        public string GetURLParameter() {
            return LicenseParameters.DevelopmentLimitURLParameter;
        }

        public string GetWatermark() {
            if (string.IsNullOrEmpty(LicenseParameters.DevelopmentLimitWatermark)) {
                return LicenseParameters.DevelopmentLimitWatermark;
            } else {
                string sessionId = HttpContext.Current.Session.SessionID;
                HttpCookie cookie = HttpContext.Current.Request.Cookies.Get("OSWatermark");
                if (null != cookie && sessionId == cookie.Value) {
                    if (HttpContext.Current.Session.IsNewSession) {
                        cookie.Value = "Reset";
                        HttpContext.Current.Response.Cookies.Add(cookie);
                    } else {
                        return string.Empty;
                    }
                }
                return LicenseParameters.DevelopmentLimitWatermark.Replace("[SessionId]", sessionId);
            }
        }

        #region Callback debug Information

        public string GetCallbackDebugInformation() {
            string ssInformation = string.Empty;
            int userId = (int)OsContext.Session.UserId;

            ssInformation += "<br/>";
            ssInformation += "------------------------------------------------CALLBACK DEBUG INFORMATION----------------------------------------------------<br/>";

            ssInformation += CallbackResultStorage.GetPropertyText("eSpace Id", eSpaceId);
            ssInformation += CallbackResultStorage.GetPropertyText("eSpace Name", eSpaceName);
            ssInformation += CallbackResultStorage.GetPropertyText("eSpace Version Id", eSpaceVersionId);
            ssInformation += CallbackResultStorage.GetPropertyText("User Id", userId);
            ssInformation += CallbackResultStorage.GetPropertyText("User Name", OsContext.Session.UserName);
            ssInformation += CallbackResultStorage.GetPropertyText("OsContext.ResponseDisabledFeedback", OsContext.ResponseDisabledFeedback);
            ssInformation += CallbackResultStorage.GetPropertyText("OsContext.ResponseDisabledTaskBox", OsContext.ResponseDisabledTaskBox);
            ssInformation += CallbackResults.GetDebugInformation();
            ssInformation += OsContext.Session.CallbackResults.GetDebugInformation();
            ssInformation += OsContext.CallbackResults.GetDebugInformation();
            return ssInformation;
        }

        #endregion
        public void EvaluateJavascriptCacheInvalidation() {
            if (_needsToTouchSC) {
                _needsToTouchSC = false;
                GenericExtendedActions.EspaceInvalidate(OsContext, ServiceCenterId, 0);
            }
        }

        public string GetInjectedContent(CodeInjectionFactory.Locations location, bool allowsCallbacks, string webScreenKey, string webScreenName) {
            InjectionCache cache;
            Callbacks.CallbackPageContext context = null;

            lock (_injectionCacheLockingObject) {
                cache = InjectionCache;
            }
            if (allowsCallbacks) {
                context = new Callbacks.CallbackPageContext(OsContext, ObjectKey.Parse(webScreenKey), webScreenName);
            }
            if (location == CodeInjectionFactory.Locations.HeadTop) { // run only in the first call (assuming HeadTop as the first)
                cache.RunCallbacks(this, OsContext.Session, Callbacks.CallbackEvent.PageRender);
            }
            return cache.RetrieveContentInjection(location, allowsCallbacks, this, OsContext.Session, context).StrCat(string.Empty);
        }

        #endregion Development Limitations
        // When Detaching, we don't want to validate End-Users limitation
        public void CheckUserLimit(Transaction trans, EndUserAction action, int userId, bool toBeActive, int limit, 
                Func<int> usageGetter, string errorMessageCreate, string errorMessageBecameActive) {
        }

        public void ValidateEndUserAction(Transaction trans, EndUserAction action, int userId, bool toBeActive) {
        }

        #region Selective Logging
        public bool SelectiveLoggingEnabled {
            get {
                return LicenseParameters.SelectiveLoggingEnabled;
            }
        }
        #endregion Selective Logging

        #region Application Monitoring
        public bool ApplicationMonitoringEnabled {
            get {
                return LicenseParameters.ApplicationMonitoringEnabled;
            } 
            set {
                LicenseParameters.ApplicationMonitoringEnabled = value;
            }
        }
        #endregion Application Monitoring

        #region Multilingual
        public bool MultilingualEnabled {
            get {
                return LicenseParameters.MultilingualEnabled;
            }
        }
        #endregion Multilingual

        #region Requests Notification

        public void NotifyBeginRequest() {
            // Nothing to do right now. Leaving the callback here for future usages
        }

        #endregion Requests Notification


        #region Platform Extensibility APIs

        internal bool PlatformExtensibilityAPIsEnabled {
            get {
                return LicenseParameters.PlatformExtensibilityAPIsEnabled;
            }
        }
        internal void CheckPlatformExtensibilityAPIs() {
            if (!PlatformExtensibilityAPIsEnabled) {
                throw new LicensingException("Your platform license does not allow you to use Platform Extensibility APIs. You must request a new platform license to use this feature.");
            }
        }
        #endregion Platform Extensibility APIs

        #region Multi-tenancy
        internal void CheckMultitenancy() {
            if (!LicenseParameters.MultitenancyAllowed) {
                throw new LicensingException("Your platform license does not allow you to use Multi-Tenancy. You must request a new platform license to use this feature.");
            }
        }
        #endregion Multi-tenancy

        #endregion Activation

        // TODO: Use GUID to get espace id.
        public int eSpaceId {
            get {
                return _eSpaceId;
            }
        }

        public Dictionary<string, object> DataBaseConfigurationDetails {
            get {
                return _dataBaseConfigurationDetails;
            }
        }

        public string CatalogName {
            get {
                return _catalogName;
            }
        }

        private string _eSpaceUIDAsString;
        public string eSpaceUID {
            get {
                return _eSpaceUIDAsString;
            }
        }

        public ObjectKey eSpaceUIDAsKey {
            get {
                return _eSpaceUID;
            }
        }

        public string eSpaceName {
            get {
                return _eSpaceName;
            }
        }

        public int eSpaceVersionId {
            get {
                return _eSpaceVersionId;
            }
        }

        private string _applicationUID;
        public string ApplicationUID {
            get {
                return _applicationUID;
            }
        }


        private ObjectKey _applicationUIDAsKey;
        public ObjectKey ApplicationUIDAsKey {
            get {
                return _applicationUIDAsKey;
            }
        }

        private Func<IEnumerable<GlobalObjectKey>> _getStaticEntities;
        public IEnumerable<GlobalObjectKey> StaticEntitiesKeys {
            get {
                return _getStaticEntities != null ? _getStaticEntities() : Enumerable.Empty<GlobalObjectKey>();
            }
        }

        public string ApplicationName {
            get {
                return RuntimePlatformSettings.Application.Name.GetValue();
            }
        }

        [Obsolete("Use IsForcingSecurityForScreens() instead.")]
        public bool IsForcingSecurityForScreens(int eSpaceId) {
            return IsForcingSecurityForScreens();
        }

        public bool IsForcingSecurityForScreens() {
            return false;
}
        
        public bool IsHSTSEnabled() {
            return false;
        }

        public bool IsForcingSecurityForIntegrations() {
           return false;
        }

        public bool IsForcingContentSecurityPolicy() {
        return false;
        }

        public string GetBaseUri() {
        return "";
        }

        public string GetChildSrc() {
        return "";
        }

        public string GetConnectSrc() {
        return "";
        }

        public string GetDefaultSrc() {
        return "";
        }

        public string GetFontSrc() {
        return "";
        }

        public string GetImgSrc() {
        return "";
        }

        public string GetMediaSrc() {
        return "";
        }

        public string GetObjectSrc() {
        return "";
        }

        public string GetPluginTypes() {
        return "";
        }

        public string GetScriptSrc() {
        return "";
        }

        public string GetStyleSrc() {
        return "";
        }

        public string GetFrameAncestors() {
        return "";
        }

        public string GetReportTo() {
        return "";
        }

        public string GetOtherDirective() {
        return "";
        }

        public JQueryVersion JQueryVersion {
            get {
                return _jQueryVersion;
            }
        }

        public string FrontendName {
            get {
                return _frontendName;
            }
        }

        public string EnvironmentKey {
            get {
                return _environmentKey;
            }
        }

        public string EnvironmentName {
            get {
                return _environmentName;
            }
        }

        public string CacheInvalidationURLSuffix {
            get {
                return _cacheInvalidationURLSuffix;
            }
        }

        public bool IsMultiTenant {
            get {
                return _isMultitenant;
            }
        }

        public bool IsMobileRuntime {
            get {
                return _isMobileRuntime;
            }
        }

        public bool IsLoadingScreen {
            get {
                return Convert.ToBoolean(HttpContext.Current.Items["osIsLoadingScreen"]);
            }
            set {
                HttpContext.Current.Items["osIsLoadingScreen"] = value;
            }
        }

        public string PtaName {
            get {
                return GetRequestPtaName();
            }
        }

        public string PtaUserName {
            get {
                return (string)HttpContext.Current.Items["osCurrentPTAUserName"];
            }
        }

        public string PtaPath {
            get {
                return (PtaName == "" ? "" : PtaName + "/");
            }
        }

        [Obsolete("Deprecated. Use eSpaceName instead.")]
        public string TenantPath {
            get {
                return eSpaceName;
            }
        }

        public int TenantId {
            get {
                return Tenant?.Id ?? 0;
            }
        }

        public TenantInfo Tenant {
            get {
                int currentTenantId = OsContext.Session.TenantId;

                if (_tenants[currentTenantId] == null) {
                    lock (_tenants) {
                        if (_tenants[currentTenantId] == null) {
                            TenantInfo tenant;

                            try {
                                tenant = new TenantInfo(currentTenantId, this);
                            } catch (Exception e) {
                                throw new InvalidOperationException("Error creating tenant", e);
                            }

                            _tenants[currentTenantId] = tenant;
                        }
                    }
                }
                TenantInfo info = (TenantInfo)_tenants[currentTenantId];
                // Paranoia check (#27345)
                if (info != null && info.Id == 0) {
                    string espaceName = "";
                    try {
                        espaceName = info.App.eSpaceName;
                    } catch {
                    }
                    try {
                        HeContext context = null;
                        try { context = info.App.OsContext; } catch { }
                        Log.ErrorLog.LogApplicationError("Invalid TenantInfo found for eSpace '" + espaceName + ". Discarding it.", "", context, "RuntimePlatform");
                    } catch {
                    }
                    _tenants.Remove(currentTenantId);
                    info = null;
                }
                return info;
            }
        }

        public ObjectKey UserProviderEspaceKeyAsKey {
            get {
                return _userProviderEspaceKey;
            }
        }

        public string UserProviderEspaceKey {
            get {
                return ObjectKeyUtils.DatabaseValue(_userProviderEspaceKey);
            }
        }

        public string UserProviderName {
            get {
                return _userProviderName;
            }
        }

        internal int DefaultTenantId {
            get {
                return _defaultTenantId;
            }
        }

        [Obsolete("Deprecated. Please use OsContext.Session.TenantId instead.")]
        public int UserProviderTenantId {
            get {
                return OsContext.Session.TenantId;
            }
        }

        public string VisitId {
            get {
                return (string)Context.Items["osVisit"];
            }
        }

        public string VisitorId {
            get {
                return (string)Context.Items["osVisitor"];
            }
        }

        public const string CookieNameSeparationChar = ".";
        public string PersitentLoginCookieName {
            get {
                string cookieName = string.Empty;

                if (!string.IsNullOrEmpty(UserProviderName)) {
                    cookieName = UserProviderName;
                } else {
                    cookieName = eSpaceName;
                    if (IsMultiTenant) {
                        cookieName += CookieNameSeparationChar + Tenant.Name;
                    }
                }
                return cookieName;
            }
        }

        public const string SFPSuffix = "sid";
        public string SessionFixationProtectionCookieName {
            get {
                string cookieName = PersitentLoginCookieName;
                cookieName += CookieNameSeparationChar + SFPSuffix;

                return cookieName;
            }
        }

        public string SessionFixationProtection {
            get {
                return (string)Context.Items[SessionFixationProtectionCookieName];
            }
        }
        private volatile MobileLoginConfiguration _mobileLoginConfig = null;

        public MobileLoginConfiguration GetMobileLoginConfigurations() {
            if (_mobileLoginConfig == null) {
                lock (_mobileLoginConfigLockingObject) {
                    if (_mobileLoginConfig == null) {
                        try {
                            string encryptKey = RuntimePlatformSettings.Authentication.MobileLogin_AuthenticationEncryptKey.GetValue();
                            if (string.IsNullOrEmpty(encryptKey)) {
                                throw new InvalidOperationException("Unable to retrieve mobile application's encrypt key");
                            }

                            string hmacKey = RuntimePlatformSettings.Authentication.MobileLogin_AuthenticationHMACKey.GetValue();
                            if (string.IsNullOrEmpty(hmacKey)) {
                                throw new InvalidOperationException("Unable to retrieve mobile application's authentication key");
                            }

                            int cacheTimeInMinutes = RuntimePlatformSettings.Authentication.MobileLogin_CacheTimeInMinutes.GetValue();
                            int persistentLoginIdleTimeInDays = RuntimePlatformSettings.Authentication.MobileLogin_Persistent_MaxIdleTimeInDays.GetValue();
                            int persistentCookieExpirationInDays = RuntimePlatformSettings.Authentication.MobileLogin_Persistent_CookieExpirationInDays.GetValue();
                            int sessionLoginIdleTimeInMinutes = RuntimePlatformSettings.Authentication.MobileLogin_Session_MaxIdleTimeInMinutes.GetValue();

                            _mobileLoginConfig = new MobileLoginConfiguration(
                                encryptKey,
                                hmacKey,
                                TimeSpan.FromMinutes(cacheTimeInMinutes),
                                TimeSpan.FromDays(persistentLoginIdleTimeInDays),
                                TimeSpan.FromDays(persistentCookieExpirationInDays),
                                TimeSpan.FromMinutes(sessionLoginIdleTimeInMinutes),
                                DefaultTenantId,
                                UserProviderEspaceKey);
                        } catch (Exception e) {
                            throw new InvalidOperationException("Unable to retrieve mobile application's authentication configurations", e);
                        }
                    }
                }
            }
            
            return _mobileLoginConfig;
        }

        public HttpContext Context {
            get {
                return HttpContext.Current;
            }
        }

        private bool InvalidOsContext() {
            return Context == null || Context.Items == null;
        }

        public HeContext OsContext {
            get {
                if (InvalidOsContext()) {
                    return null;
                }
                if (Context.Items["osContext"] == null) {
                    Context.Items["osContext"] = new HeContext();
                }
                return (HeContext)Context.Items["osContext"];
            }
            set {
                Context.Items["osContext"] = value;
            }
        }

        public int GetApplicationDefaultTimeout() {
            return RuntimePlatformSettings.Application.DefaultTimeout.GetValue();
        }

        private string GetQueryString(HttpRequest request) {
            if (null == request.QueryString) {
                return string.Empty;
            } else {
                return request.QueryString.ToString();
            }
        }

        public bool IsApplicationEnabled {
            get {
                bool isApplicationEnabled = Properties.EspaceApplicationEnabled;
                bool isTenantActive = Tenant.IsActive;

                if (!isApplicationEnabled || !isTenantActive) {
                    if (!isTenantActive) {
                        //if we failed because of a disabled espace, try to clear the session to proceed with a default one
                        OsContext.Session.Clear();
                        isTenantActive = Tenant.IsActive;
                    }
                    if (!isApplicationEnabled || !isTenantActive) {
                        return false;
                    }
                }
                return true;
            }
        }

        public void CheckIsApplicationEnabled() {
            if (!IsApplicationEnabled) {
                throw new Exception("The Application is offline." + (Tenant.IsActive ? "" : (" Tenant " + Tenant.Name + " is disabled.")));
            }
        }

    public AppInfo(ESpaceInfoForAppStart eSpaceInfo) {

            _eSpaceId = eSpaceInfo.ESpaceId;
            _eSpaceUID = eSpaceInfo.ESpaceKey;
            _eSpaceUIDAsString = ObjectKeyUtils.DatabaseValue(_eSpaceUID);
            _eSpaceName = eSpaceInfo.ESpaceName;
            _isMultitenant = eSpaceInfo.IsMultiTenant;
            _isMobileRuntime = eSpaceInfo.IsMobileRuntime;

            _getStaticEntities = eSpaceInfo.GetStaticEntities;
            _applicationUIDAsKey = ObjectKey.Parse(RuntimePlatformSettings.Application.Key.GetValue());
            _applicationUID = ObjectKeyUtils.DatabaseValue(_applicationUIDAsKey);

            // Set user provider eSpace information
            if (eSpaceInfo.UserProviderKey != null) {
                _userProviderEspaceKey = eSpaceInfo.UserProviderKey;
                _userProviderName = eSpaceInfo.UserProviderName;
            } else { 
                // The current tenant is its own user provider
                _userProviderEspaceKey = _eSpaceUID;
                _userProviderName = _eSpaceName;
            }

            using (var trans = DatabaseAccess.ForRuntimeDatabase.GetReadOnlyTransaction()) {
                _defaultTenantId = DBRuntimePlatform.Instance.GetDefaultTenantIdByUserProviderEspaceKey(trans, _userProviderEspaceKey, "-");
            }

            _eSpaceVersionId = RuntimePlatformSettings.Module.VersionId.GetValue();
            _jQueryVersion = eSpaceInfo.ESpaceJQueryVersion;

            _dataBaseConfigurationDetails = eSpaceInfo.DataBaseConfigurationDetails;
            _catalogName = eSpaceInfo.CatalogName;

            // Sanity check because of tenantid=0 and/or espaceid=0 error (#27345)
            if (_eSpaceId <= 0 || _eSpaceName.IsEmpty()) {
                throw new InvalidOperationException("Invalid eSpace info provided to AppInfo : eSpace Id: " + _eSpaceId + ", eSpace Name: '" + _eSpaceName + "'");
            }

            if (_defaultTenantId == 0) {
                throw new InvalidOperationException("Invalid eSpace info. Could not find the User Provider in this server.");
            }

            _frontendName = RuntimeEnvironment.MachineName;
            _environmentKey = RuntimePlatformSettings.Environment.Key.GetValue();
            _environmentName = RuntimePlatformSettings.Environment.Name.GetValue();
            _cacheInvalidationURLSuffix = eSpaceInfo.CacheInvalidationSuffix;

            // store this app in the HttpContext
            SetAppInfo(HttpContext.Current, this);
            
            // Init the properties
            Properties = new EspaceProperties();
            ExtensionProperties = new ExtensionPropertiesCache(this);
            LicenseParameters = new LicenseParameters(eSpaceInfo, null, false);
        }

        #region Callbacks

        public InjectionCache InjectionCache {
            get {
                if (_injectionCache == null) {
                    lock (_injectionCacheLockingObject) {
                        if (_injectionCache == null) {
                            _injectionCache = BuildInjectionCache();
                        }
                    }
                }
                return _injectionCache;
            }
        }
        public Callbacks.CallbackResultStorage CallbackResults {
            get {
                if (_callbackStorage == null) {
                    lock (_injectionCacheLockingObject) {
                        if (_callbackStorage == null) {
                            _callbackStorage = new Callbacks.CallbackResultStorage();
                        }
                    }
                }
                return _callbackStorage;
            }
        }

        public void InvalidateInjectionCache() {
            lock (_injectionCacheLockingObject) {
                _needsToTouchSC = true;
            }
        }

        public void InvalidateCallbackCache() {
            lock (_injectionCacheLockingObject) {
                _injectionCache = null;
                _callbackStorage = null;
            }
        }

        private InjectionCache BuildInjectionCache() {
            using (Transaction tran = DatabaseAccess.ForRuntimeDatabase.GetCommitableTransaction()) {
                bool IsCallbackProviderWithHide = DBRuntimePlatform.Instance.IsCallbackProviderWithHideSetting(tran, eSpaceName);

                using (IDataReader reader = DBRuntimePlatform.Instance.GetExternalCodeByEspaceOrApplication(tran, eSpaceId, ApplicationUID, eSpaceUID)) {
                    try {
                        return CodeInjectionFactory.Instance.ReadInjectionElements(reader, _eSpaceUID, IsCallbackProviderWithHide);
                    } catch (Exception e) {
                        ErrorLog.StaticWrite(DateTime.Now, "", eSpaceId, 0, 0, e.Message, e.StackTrace, "InjectionCache");
                        return CodeInjectionFactory.Instance.EmptyInjectionCache();
                    }
                }
            }
        }

        [ThreadStatic]
        private static bool insertingCache = false;

        public void SetupInvalidateCallbackCache() {
            if (!insertingCache && RuntimeCache.Instance.Get(new CacheKey("callbackCache" + eSpaceId)) == null) { // prevent double inserts and overflows
                insertingCache = true;
                
                var aggregate = new RuntimeCommon.Caching.AggregateCacheDependency(
                    new EspaceTenantDependency(eSpaceId, 0),
                    new EspaceTenantDependency(ServiceCenterId, 0));

                RuntimeCache.Instance.Listen(
                            new CacheKey("callbackCache" + eSpaceId),
                            aggregate,
                            InvalidateCallbackCacheCallback);

                insertingCache = false;
            }
        }


        private void InvalidateCallbackCacheCallback() {
            HeContext context = null;
            try { context = OsContext; } catch { }
            lock (_injectionCacheLockingObject) {
                try {
                    InvalidateCallbackCache();
                } catch (Exception e) {
                    ErrorLog.LogApplicationError(e, context, "RuntimePlatform");
                }
            }
        }

        #endregion

        #region New Runtime Cookies

        private string CookieSuffix {
            get {
                if (string.IsNullOrEmpty(UserProviderName)) {
                    return eSpaceName;
                } else {
                    return UserProviderName;
                }
            }
        }

        public string UserAccessibleLoginCookieName {
            get { return "nr2" + CookieSuffix; }
        }

        public string HttpOnlyLoginCookieName {
            get { return "nr1" + CookieSuffix; }
        }

        public string CSRFHeaderName {
            get { return "X-CSRFToken"; }
        }

        #endregion

        internal static void GetAppInfoInformation(out int espaceid, out int tenantid, out string sessionid, out int userid) {
            espaceid = 0;
            tenantid = 0;
            userid = 0;
            sessionid = "";

            if (HttpContext.Current != null) {
                AppInfo info = (AppInfo)HttpContext.Current.Application["appInfo"];

                if (info != null) {
                    HeContext heContext = info.OsContext;
                    espaceid = info.eSpaceId;
                    try { tenantid = info.Tenant.Id; } catch { }
                    try { sessionid = heContext.Session.SessionID; } catch { }
                    try { userid = heContext.Session.UserId; } catch { }
                }
            }
        }


        public static AppInfo GetAppInfo(HttpContext context) {
            var info = (AppInfo)context.Application["appInfo"];
            return info;
        }

        public static AppInfo GetAppInfo() {
            AppInfo info = null;
            if (HttpContext.Current != null) {
                info = GetAppInfo(HttpContext.Current);
            }

            // Paranoia check (#27345)
            if (info != null && info.eSpaceId == 0) {
                int tenantId = 0;
                try {
                    tenantId = info.Tenant.Id;
                } catch {
                }
                try {
                    HeContext context = null;
                    try { context = info.OsContext; } catch { }
                    Log.ErrorLog.LogApplicationError("Invalid AppInfo found for eSpace '" + info.eSpaceName + "' with TenantId=" + tenantId + ". Discarding it.", "", context, "RuntimePlatform");
                } catch {
                }
                SetAppInfo(HttpContext.Current, null);
                info.Dispose();
                info = null;
            }
            return info;
        }

        public static void SetAppInfo(HttpContext context, AppInfo appInfo) {
            context.Application["appInfo"] = appInfo;
        }

        [Obsolete("This API is Obsolete and has moved to the Settings.Get(name)")]
        public static string GetParameter(string name) {
            return Settings.Get(name);
        }

        [Obsolete("This API is Obsolete and has moved to the Settings.Get(name)")]
        public static string GetParameter(string name, bool isNodeSetting) {
            return Settings.Get(name);
        }

        [Obsolete("This API is Obsolete and has moved to the Settings.Get(name, transaction)")]
        public static string GetParameter(string name, bool isNodeSetting, Transaction transaction) {
            return Settings.Get(name, transaction);
        }

        [Obsolete("This API is Obsolete and has moved to the Settings.Set(name, value)")]
        public static void SetParameter(string name, string val) {
            Settings.Set(name, val);
        }

        [Obsolete("This API is Obsolete and has moved to the Settings.Set(name, value)")]
        public static void SetParameter(string name, string val, bool isNodeParameter) {
            Settings.Set(name, val);
        }

        [Obsolete("Deprecated.Please use GetRequestPtaName() instead.")]
        public static string GetRequestPtaName(string applicationPath) {
            return GetRequestPtaName();
        }

        public static string GetRequestPtaName() {
            return RuntimePlatformSettings.Module.PersonalAreaName.GetValue();
        }

        public void Dispose() {
            _espaces.Values.ToList().ForEach(e => e.Dispose());
        }
    }

    public class WSEnhancementsElementWithSoapHeaders : WSEnhancementsElement {

        public WSEnhancementsElementWithSoapHeaders(string WRName)
            : base(WRName) {
        }

        private Func<SoapUnknownHeader[]> _getSoapHeaders;

        public SoapUnknownHeader[] SOAPHeaders {
            get {
                return _getSoapHeaders();
            }
        }

        private static string GetHeadersKey(bool isWebService, bool forExtension, string name) {
            if (name == null)
                name = "_";
            return name + (isWebService ? "Service" : "Reference") + (forExtension ? "Extension" : "Internal");
        }

        public static SoapUnknownHeader[] GetHeaders(HeContext context, string name, bool isWebService, bool forExtension) {
            string key = GetHeadersKey(isWebService, forExtension, name);
            WSEnhancementsElementWithSoapHeaders elem = (WSEnhancementsElementWithSoapHeaders)getElementFromContext(context, key);
            return elem == null ? null : elem.SOAPHeaders;
        }

        public static void SetHeaders(HeContext context, string name, bool isWebService, bool forExtension, SoapUnknownHeader[] headers) {
            SetHeadersDataSource(context, name, isWebService, forExtension, () => headers);
        }

        public static void SetHeadersDataSource(HeContext context, string name, bool isWebService, bool forExtension, Func<SoapUnknownHeader[]> headersDataSource) {
            string key = GetHeadersKey(isWebService, forExtension, name);
            Hashtable WSEnhancementsHt = (Hashtable)context.Context.Items["WSEnhancementsHashtable"];
            if (WSEnhancementsHt == null) {
                WSEnhancementsHt = new Hashtable();
                WSEnhancementsElementWithSoapHeaders elem = new WSEnhancementsElementWithSoapHeaders(key);
                elem._getSoapHeaders = headersDataSource;
                WSEnhancementsHt.Add(elem.Wrname, elem);
            } else {
                WSEnhancementsElementWithSoapHeaders elem = (WSEnhancementsElementWithSoapHeaders)WSEnhancementsHt[key];
                if (elem == null) {
                    elem = new WSEnhancementsElementWithSoapHeaders(key);
                    elem._getSoapHeaders = headersDataSource;
                    WSEnhancementsHt.Add(elem.Wrname, elem);
                } else {
                    elem._getSoapHeaders = headersDataSource;
                }

            }
            context.Context.Items["WSEnhancementsHashtable"] = WSEnhancementsHt;
        }
    }

    //deprecated class, do not use this one (here because EnhancedWebReferences Extension use this
    //we cannot use the soapunknown header class here because EnhancedWebReferences will get this error
    //The type 'System.Web.Services.Protocols.SoapUnknownHeader' is defined in an assembly that is not referenced.
    public class WSEnhancementsElement {

        protected string _wrname;

        public string Wrname {
            get {
                return _wrname;
            }
            set {
                _wrname = value;
            }
        }

        protected string _url;

        public string Url {
            get {
                return _url;
            }
            set {
                if (value.Length == 0) {
                    _url = null;
                } else {
                    _url = value;
                }
            }
        }

        protected string _username;

        public string Username {
            get {
                return _username;
            }
            set {
                _username = value;
            }
        }

        protected string _password;

        public string Password {
            get {
                return _password;
            }
            set {
                _password = value;
            }
        }

        protected string _proxyUrl;

        public string ProxyUrl {
            get {
                return _proxyUrl;
            }
            set {
                _proxyUrl = value;
            }
        }

        protected string _proxyUsername;

        public string ProxyUsername {
            get {
                return _proxyUsername;
            }
            set {
                _proxyUsername = value;
            }
        }

        protected string _proxyPassword;

        public string ProxyPassword {
            get {
                return _proxyPassword;
            }
            set {
                _proxyPassword = value;
            }
        }

        public WSEnhancementsElement() {

        }

        public WSEnhancementsElement(string WRName) {
            _wrname = WRName;
        }
        public WSEnhancementsElement(string WRName, string url) {
            _wrname = WRName;
            _url = url;
        }

        public WSEnhancementsElement(string WRName, string username, string password) {
            _wrname = WRName;
            _username = username;
            _password = password;
        }

        public WSEnhancementsElement(string WRName, string proxyUrl, string proxyUsername, string proxyPassword) {
            _wrname = WRName;
            _proxyUrl = proxyUrl;
            _proxyUsername = proxyUsername;
            _proxyPassword = proxyPassword;
        }

        protected static WSEnhancementsElement getElementFromContext(HeContext context, string ssWebServiceName) {
            Hashtable wsEnhancementsHt = (Hashtable)context.Context.Items["WSEnhancementsHashtable"];
            if (wsEnhancementsHt != null) {
                return (WSEnhancementsElement)wsEnhancementsHt[ssWebServiceName];
            } else {
                return null;
            }
        }

        public static string getWSUrl(HeContext context, string ssWebServiceName, string backupUrl) {
            return getWSUrl(context, ssWebServiceName, backupUrl, null);
        }

        public static string getWSUrl(HeContext context, string ssWebServiceName, string backupUrl,
                                      WSEnhancementsElement elem) {
            if (elem == null) {
                elem = getElementFromContext(context, ssWebServiceName);
            }
            if (elem != null && !string.IsNullOrEmpty(elem.Url)) {
                return elem.Url;
            } else {
                return backupUrl;
            }
        }

        public static void setWSCredentials(HeContext context, string ssWebServiceName, SoapHttpClientProtocol ws) {
            setWSCredentials(context, ssWebServiceName, ws, null);
        }

        public static void setWSCredentials(HeContext context, string ssWebServiceName, SoapHttpClientProtocol ws,
                                            WSEnhancementsElement elem) {
            if (elem == null) {
                elem = getElementFromContext(context, ssWebServiceName);
            }

            if (elem != null && !string.IsNullOrEmpty(elem.Username)) {
                ws.Credentials = getNetworkCredential(elem.Username, elem.Password);
            } else {
                ws.Credentials = null;
            }
        }

        private static NetworkCredential getNetworkCredential(string username, string password) {
            string domainUserName, domainName;
            int posSeparator = username.IndexOf('\\');
            if (posSeparator >= 0) {
                domainName = username.Substring(0, posSeparator);
                domainUserName = username.Substring(posSeparator + 1);
                return new NetworkCredential(domainUserName, password, domainName);
            }
            return new NetworkCredential(username, password);
        }

        public static void setWSProxy(HeContext context, string ssWebServiceName, SoapHttpClientProtocol ws) {
            setWSProxy(context, ssWebServiceName, ws, null);
        }

        public static void setWSProxy(HeContext context, string ssWebServiceName, SoapHttpClientProtocol ws,
                                            WSEnhancementsElement elem) {
            if (elem == null) {
                elem = getElementFromContext(context, ssWebServiceName);
            }
            if (elem == null || elem.ProxyUrl == null) {
                return;
            }
            WebProxy proxy = new WebProxy(elem.ProxyUrl);
            if (!string.IsNullOrEmpty(elem.ProxyUsername)) {
                proxy.Credentials = getNetworkCredential(elem.ProxyUsername, elem.ProxyPassword);
            }
            ws.Proxy = proxy;
        }

        public static void RefreshWSElement(HeContext context, System.Web.Services.Protocols.SoapHttpClientProtocol ws, string ssWebServiceName, string backupUrl) {
            WSEnhancementsElement elem = getElementFromContext(context, ssWebServiceName);
            string wsURL = getWSUrl(context, ssWebServiceName, backupUrl, elem);
            ws.Url = wsURL;
            setWSProxy(context, ssWebServiceName, ws, elem);
            setWSCredentials(context, ssWebServiceName, ws, elem);
        }
    }
}
